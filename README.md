# dokku-auth

LDAP directory and SSO authentication plugin for [Dokku](https://dokku.com/).

## Features

- **Multiple Directory Providers**: LLDAP (default), GLAuth, OpenLDAP
- **Multiple Frontend Providers**: Authelia (default) for SSO/2FA
- **OIDC Support**: Enable OpenID Connect for apps
- **Simple Linking**: Apps get `LDAP_URL`, `LDAP_BASE_DN`, etc. automatically
- **Multi-Instance**: Run multiple directory/frontend services simultaneously
- **Network-based**: Uses Docker networks for stable connections
- **Default Group Sync**: Users in default group auto-added to new app groups

## Quick Start

```bash
# Install the plugin
dokku plugin:install https://github.com/deanmarano/dokku-auth.git auth

# Create a directory service (LLDAP by default)
dokku auth:create production

# Link an app
dokku auth:link production myapp
dokku ps:restart myapp

# Optionally add SSO with Authelia
dokku auth:frontend:create auth
dokku auth:frontend:config auth DOMAIN=auth.example.com
dokku auth:frontend:use-directory auth production
dokku auth:frontend:apply auth
dokku auth:frontend:protect auth myapp
```

## Commands

### Directory Services

```bash
# Service lifecycle
dokku auth:create <service>                 # Create directory service
dokku auth:destroy <service> [-f]           # Delete directory service
dokku auth:list                             # List all services
dokku auth:info <service>                   # Show service details
dokku auth:status <service>                 # Health check
dokku auth:logs <service> [-t|--tail]       # View logs
dokku auth:doctor <service> [-v]            # Diagnose issues
dokku auth:credentials <service>            # Show LDAP bind credentials

# App linking
dokku auth:link <service> <app>             # Link app to directory
dokku auth:unlink <service> <app>           # Unlink app
dokku auth:sync <service>                   # Sync default group to app groups

# Provider management
dokku auth:providers                        # List available providers
dokku auth:provider:set <svc> <provider>    # Change provider
dokku auth:provider:config <svc> KEY=value  # Configure provider
dokku auth:provider:apply <svc>             # Apply configuration
```

### Frontend Services (SSO/2FA)

```bash
# Service lifecycle
dokku auth:frontend:create <service>        # Create frontend service
dokku auth:frontend:destroy <service> [-f]  # Delete frontend service
dokku auth:frontend:list                    # List all frontend services
dokku auth:frontend:info <service>          # Show service details
dokku auth:frontend:status <service>        # Health check
dokku auth:frontend:logs <service>          # View logs

# Directory integration
dokku auth:frontend:use-directory <svc> <dir-svc>  # Link to directory

# App protection
dokku auth:frontend:protect <svc> <app>     # Add SSO protection
dokku auth:frontend:unprotect <svc> <app>   # Remove protection

# Provider management
dokku auth:frontend:provider:set <svc> <prov>   # Change provider
dokku auth:frontend:config <svc> KEY=value      # Configure provider
dokku auth:frontend:apply <svc>                 # Apply configuration
```

### OIDC (OpenID Connect)

```bash
dokku auth:oidc:enable <frontend-svc>                          # Enable OIDC
dokku auth:oidc:disable <frontend-svc>                         # Disable OIDC
dokku auth:oidc:add-client <svc> <id> [secret] [redirect-uri]  # Add client
dokku auth:oidc:remove-client <svc> <client-id>                # Remove client
dokku auth:oidc:list <svc>                                     # List clients
```

## App Environment Variables

When linked to a directory service, apps receive:

```bash
LDAP_URL=ldap://dokku.auth.directory.production:3890
LDAP_BASE_DN=dc=dokku,dc=local
LDAP_BIND_DN=uid=admin,ou=people,dc=dokku,dc=local
LDAP_BIND_PASSWORD=<auto-generated>
```

When protected by a frontend service:

```bash
AUTHELIA_URL=http://dokku.auth.frontend.auth:9091
AUTHELIA_DOMAIN=auth.example.com
```

## Directory Providers

### LLDAP (Default)

Lightweight LDAP server with a web UI for user management.

```bash
dokku auth:create myservice
# Web UI available at HTTP port configured via HTTP_URL
```

### GLAuth

Minimal LDAP server with config-file backends. Good for read-heavy workloads.

```bash
dokku auth:create myservice
dokku auth:provider:set myservice glauth
dokku auth:provider:apply myservice
```

Note: GLAuth requires config file edits for user/group management.

### OpenLDAP

Full-featured LDAP server for complex requirements.

```bash
dokku auth:create myservice
dokku auth:provider:set myservice openldap
dokku auth:provider:config myservice DOMAIN=example.com ORGANISATION=MyOrg
dokku auth:provider:apply myservice
```

## Frontend Providers

### Authelia (Default)

SSO portal with 2FA support (TOTP, WebAuthn).

```bash
dokku auth:frontend:create auth
dokku auth:frontend:config auth DOMAIN=auth.example.com
dokku auth:frontend:use-directory auth production
dokku auth:frontend:apply auth
```

## Multiple Instances

Run separate services for different environments:

```bash
# Production LLDAP
dokku auth:create production

# Staging LLDAP (separate users)
dokku auth:create staging

# Link apps to appropriate services
dokku auth:link production myapp
dokku auth:link staging myapp-staging

# Separate frontends too
dokku auth:frontend:create prod-auth
dokku auth:frontend:create staging-auth
```

## Default User Group

Users added to `dokku-auth-default-users` are automatically synced to all app groups when you run:

```bash
dokku auth:sync production
```

This makes it easy to grant new users access to all linked apps.

## Development

```bash
# Install test dependencies
npm install

# Run tests in Docker (isolated)
make test-docker

# Or run against local Dokku
make test

# Run specific test file
npm test -- tests/integration/directory-lldap.test.ts
```

## Architecture

```
dokku-auth/
├── commands              # Main command dispatcher
├── config                # Plugin configuration
├── install               # Post-install hook
├── providers/
│   ├── loader.sh        # Provider loading logic
│   ├── directory/       # Directory providers
│   │   ├── lldap/
│   │   ├── glauth/
│   │   └── openldap/
│   └── frontend/        # Frontend providers
│       └── authelia/
├── subcommands/         # Individual commands
└── tests/               # TypeScript tests
```

## License

MIT
