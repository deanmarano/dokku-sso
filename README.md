# dokku-auth

LDAP directory and SSO authentication plugin for [Dokku](https://dokku.com).

## Prerequisites

- [Dokku](https://dokku.com) 0.34+

## Installation

```bash
dokku plugin:install https://github.com/deanmarano/dokku-auth.git auth
```

## Quick Start

```bash
# Create a directory service (LLDAP by default)
dokku auth:create production

# Link an app
dokku auth:link production myapp
dokku ps:restart myapp

# Optionally add SSO with Authelia
dokku auth:frontend:create auth --app authelia
# Or deploy a new one:
dokku auth:frontend:create auth
dokku auth:frontend:config auth DOMAIN=auth.example.com
dokku auth:frontend:use-directory auth production
dokku auth:frontend:apply auth

# Protect an app with forward auth
dokku auth:frontend:protect auth myapp
```

## Commands

### Directory Services

| Command | Description |
|---|---|
| `auth:create <service>` | Create directory service |
| `auth:destroy <service> [-f]` | Delete directory service |
| `auth:list` | List all services |
| `auth:info <service>` | Show service details |
| `auth:status <service>` | Health check |
| `auth:logs <service> [-t]` | View logs |
| `auth:doctor <service> [-v]` | Diagnose issues |
| `auth:credentials <service>` | Show LDAP bind credentials |
| `auth:link <service> <app>` | Link app to directory |
| `auth:unlink <service> <app>` | Unlink app |
| `auth:sync <service>` | Sync default group to app groups |
| `auth:providers` | List available providers |
| `auth:provider:set <svc> <provider>` | Change provider |
| `auth:provider:config <svc> KEY=value` | Configure provider |
| `auth:provider:apply <svc>` | Apply configuration |

### Frontend Services (SSO/2FA)

| Command | Description |
|---|---|
| `auth:frontend:create <service> [--app <app>]` | Create or adopt frontend service |
| `auth:frontend:destroy <service> [-f] [--keep-app]` | Delete frontend service |
| `auth:frontend:list` | List all frontend services |
| `auth:frontend:info <service>` | Show service details |
| `auth:frontend:status <service>` | Health check |
| `auth:frontend:logs <service>` | View logs |
| `auth:frontend:use-directory <svc> <dir-svc>` | Link to directory |
| `auth:frontend:protect <svc> <app>` | Add SSO protection |
| `auth:frontend:unprotect <svc> <app>` | Remove protection |
| `auth:frontend:provider:set <svc> <prov>` | Change provider |
| `auth:frontend:config <svc> KEY=value` | Configure provider |
| `auth:frontend:apply <svc>` | Apply configuration |

### OIDC (OpenID Connect)

| Command | Description |
|---|---|
| `auth:oidc:enable <frontend-svc>` | Enable OIDC |
| `auth:oidc:disable <frontend-svc>` | Disable OIDC |
| `auth:oidc:add-client <svc> <id> [secret] [redirect-uri]` | Add client |
| `auth:oidc:remove-client <svc> <client-id>` | Remove client |
| `auth:oidc:list <svc>` | List clients |

## App Environment Variables

When linked to a directory service, apps receive:

```
LDAP_URL=ldap://dokku.auth.directory.production:3890
LDAP_BASE_DN=dc=dokku,dc=local
LDAP_BIND_DN=uid=admin,ou=people,dc=dokku,dc=local
LDAP_BIND_PASSWORD=<auto-generated>
```

When protected by a frontend service:

```
AUTHELIA_DOMAIN=auth.example.com
```

## Directory Providers

| Provider | Description |
|---|---|
| **LLDAP** (default) | Lightweight LDAP server with web UI for user management |
| **GLAuth** | Minimal LDAP server with config-file backends |
| **OpenLDAP** | Full-featured LDAP server for complex requirements |

## Frontend Providers

| Provider | Description |
|---|---|
| **Authelia** (default) | SSO portal with 2FA support (TOTP, WebAuthn) |
| **Authentik** | Full-featured identity provider with advanced features |

## Integration Presets

Pre-configured settings are available in `integrations/` for popular apps:

**Tested (with E2E tests):** Grafana, GitLab, Jellyfin, Immich, Radarr, Home Assistant

**Untested:** Bookstack, Calibre-Web, Gitea, Guacamole, HedgeDoc, Linkding, Matrix, Miniflux, Navidrome, Nextcloud, OpenWebUI, Outline, Paperless, Portainer, Proxmox, Vaultwarden, Wiki.js, and more.

## Default User Group

Users added to `dokku-auth-default-users` are automatically synced to all app groups:

```bash
dokku auth:sync production
```

## Development

```bash
npm install
make test-docker    # Run tests in Docker (isolated)
make test           # Run against local Dokku
npx playwright test --project=grafana-ldap  # Run E2E tests
```

## License

MIT
