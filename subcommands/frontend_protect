#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE="$1"
APP="$2"

if [[ -z "$SERVICE" ]] || [[ -z "$APP" ]]; then
  echo "Usage: dokku auth:frontend:protect <frontend-service> <app>" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/frontend/$SERVICE"

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Frontend service $SERVICE does not exist" >&2
  exit 1
fi

# Check if app exists
if ! "$DOKKU_BIN" apps:exists "$APP" 2>/dev/null; then
  echo "!     App $APP does not exist" >&2
  exit 1
fi

# Check if already protected
if [[ -f "$SERVICE_ROOT/PROTECTED" ]] && grep -q "^${APP}$" "$SERVICE_ROOT/PROTECTED"; then
  echo "       App $APP is already protected by $SERVICE"
  exit 0
fi

echo "-----> Protecting $APP with $SERVICE"

load_frontend_provider "$SERVICE"
provider_protect_app "$SERVICE" "$APP"

echo "-----> App $APP is now protected"
echo ""
echo "       Note: You may need to configure your nginx proxy to use Authelia"
echo "       for forward authentication. See documentation for details."
