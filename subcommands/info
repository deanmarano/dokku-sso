#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE="$1"
FORMAT=""

# Parse arguments
for arg in "$@"; do
  case "$arg" in
    --format=*)
      FORMAT="${arg#*=}"
      ;;
  esac
done

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:info <service> [--format=json]" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/directory/$SERVICE"

# Check if service exists
if ! directory_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

load_directory_provider "$SERVICE"

CONTAINER_NAME=$(get_directory_container_name "$SERVICE")
PROVIDER=$(cat "$SERVICE_ROOT/PROVIDER" 2>/dev/null || echo "unknown")
CONFIG_DIR="$SERVICE_ROOT/config"
BASE_DN=$(cat "$CONFIG_DIR/BASE_DN" 2>/dev/null || echo "")
HTTP_URL=$(cat "$CONFIG_DIR/HTTP_URL" 2>/dev/null || echo "")

# Check status
if docker ps -q -f "name=^${CONTAINER_NAME}$" | grep -q .; then
  STATUS="running"
else
  STATUS="stopped"
fi

# Get linked apps
LINKS=""
if [[ -s "$SERVICE_ROOT/LINKS" ]]; then
  LINKS=$(cat "$SERVICE_ROOT/LINKS" | tr '\n' ',' | sed 's/,$//')
fi

if [[ "$FORMAT" == "json" ]]; then
  cat << EOF
{
  "service": "$SERVICE",
  "provider": "$PROVIDER",
  "status": "$STATUS",
  "container_name": "$CONTAINER_NAME",
  "ldap_url": "ldap://$CONTAINER_NAME:$PROVIDER_LDAP_PORT",
  "base_dn": "$BASE_DN",
  "web_url": "$HTTP_URL",
  "linked_apps": "$(cat "$SERVICE_ROOT/LINKS" 2>/dev/null | tr '\n' ',' | sed 's/,$//')"
}
EOF
else
  echo "=====> Directory service: $SERVICE"
  echo "       Status: $STATUS"
  provider_info "$SERVICE"
  echo "       LDAP URL: ldap://$CONTAINER_NAME:$PROVIDER_LDAP_PORT"
  echo ""
  echo "       Linked apps:"
  if [[ -s "$SERVICE_ROOT/LINKS" ]]; then
    cat "$SERVICE_ROOT/LINKS" | sed 's/^/         /'
  else
    echo "         (none)"
  fi
fi
