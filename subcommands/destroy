#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE=""
FORCE=""
KEEP_APP=""

for arg in "$@"; do
  case "$arg" in
    -f|--force)
      FORCE="true"
      ;;
    --keep-app)
      KEEP_APP="true"
      ;;
    *)
      [[ -z "$SERVICE" ]] && SERVICE="$arg"
      ;;
  esac
done

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:destroy <service> [-f|--force] [--keep-app]" >&2
  echo "" >&2
  echo "Options:" >&2
  echo "  -f, --force  Skip confirmation and force destroy even with linked apps" >&2
  echo "  --keep-app   Unregister without destroying the Dokku app" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/directory/$SERVICE"

# Check if service exists
if ! directory_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

# Check for linked apps
if [[ -s "$SERVICE_ROOT/LINKS" ]] && [[ -z "$FORCE" ]]; then
  echo "!     Service has linked apps:" >&2
  sed 's/^/         /' < "$SERVICE_ROOT/LINKS" >&2
  echo "" >&2
  echo "       Use --force to destroy anyway, or unlink apps first:" >&2
  echo "         dokku auth:unlink $SERVICE <app>" >&2
  exit 1
fi

# Confirm destruction
if [[ -z "$FORCE" ]]; then
  echo "!     WARNING: This will permanently delete service $SERVICE and all its data" >&2
  echo -n "       Type the service name to confirm: " >&2
  read -r CONFIRM
  if [[ "$CONFIRM" != "$SERVICE" ]]; then
    echo "!     Confirmation failed" >&2
    exit 1
  fi
fi

echo "-----> Destroying directory service $SERVICE"

# Load provider and destroy container/app (unless --keep-app)
load_directory_provider "$SERVICE"
if [[ -n "$KEEP_APP" ]]; then
  APP_NAME=$(get_directory_app_name "$SERVICE")
  if [[ -n "$APP_NAME" ]]; then
    echo "       Keeping Dokku app $APP_NAME"
  fi
else
  provider_destroy "$SERVICE"
fi

# Remove service directory
if [[ -d "$SERVICE_ROOT" ]]; then
  if ! rm -rf "$SERVICE_ROOT" 2>/dev/null; then
    if [[ "$(id -u)" != "0" ]]; then
      sudo rm -rf "$SERVICE_ROOT"
    else
      rm -rf "$SERVICE_ROOT" || true
    fi
  fi
fi

echo "-----> Directory service $SERVICE destroyed"
