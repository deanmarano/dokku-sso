#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE="$1"

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:frontend:apply <service>" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/frontend/$SERVICE"

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

load_frontend_provider "$SERVICE"

echo "-----> Applying configuration for $SERVICE"

# Validate configuration
echo "       Validating configuration..."
if ! provider_validate_config "$SERVICE"; then
  echo "!     Configuration validation failed" >&2
  exit 1
fi

# Stop existing container if running
CONTAINER_NAME=$(get_frontend_container_name "$SERVICE")
if docker ps -q -f "name=^${CONTAINER_NAME}$" | grep -q .; then
  echo "       Stopping existing container..."
  provider_destroy "$SERVICE"
fi

# Create new container
echo "       Creating container..."
provider_create_container "$SERVICE"

# Reload frontend provider (generate_authelia_config loads directory provider which overwrites functions)
load_frontend_provider "$SERVICE"

# Verify it's working
echo "       Verifying service..."
if provider_verify "$SERVICE"; then
  echo "-----> Configuration applied successfully"
else
  echo "!     Service verification failed" >&2
  exit 1
fi

# Refresh protected apps
if [[ -s "$SERVICE_ROOT/PROTECTED" ]]; then
  echo "-----> Refreshing protected apps"
  while IFS= read -r app; do
    [[ -z "$app" ]] && continue
    echo "       Refreshing $app..."
    provider_protect_app "$SERVICE" "$app" 2>/dev/null || true
  done < "$SERVICE_ROOT/PROTECTED"
fi
