#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE="$1"
DIRECTORY_SERVICE="$2"

if [[ -z "$SERVICE" ]] || [[ -z "$DIRECTORY_SERVICE" ]]; then
  echo "Usage: dokku auth:frontend:use-directory <frontend-service> <directory-service>" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/frontend/$SERVICE"

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Frontend service $SERVICE does not exist" >&2
  exit 1
fi

if ! directory_service_exists "$DIRECTORY_SERVICE"; then
  echo "!     Directory service $DIRECTORY_SERVICE does not exist" >&2
  exit 1
fi

echo "-----> Configuring $SERVICE to use directory $DIRECTORY_SERVICE"

load_frontend_provider "$SERVICE"
provider_use_directory "$SERVICE" "$DIRECTORY_SERVICE"

echo "-----> Directory configured"
echo ""
echo "       Run 'dokku auth:frontend:apply $SERVICE' to apply changes"
