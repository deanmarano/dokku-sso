#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE="$1"
shift || true

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:logs <service> [-t|--tail] [-n <lines>]" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/directory/$SERVICE"

# Check if service exists
if ! directory_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

load_directory_provider "$SERVICE"

# Check if this is a Dokku app or legacy Docker container
APP_NAME=$(get_directory_app_name "$SERVICE")

if [[ -n "$APP_NAME" ]]; then
  # Translate options for dokku logs
  DOKKU_OPTS=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -t|--tail)
        DOKKU_OPTS+=("--tail")
        shift
        ;;
      -n)
        DOKKU_OPTS+=("--num" "$2")
        shift 2
        ;;
      *)
        DOKKU_OPTS+=("$1")
        shift
        ;;
    esac
  done
  provider_logs "$SERVICE" "${DOKKU_OPTS[@]}"
else
  # Legacy Docker: translate options for docker logs
  DOCKER_OPTS=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -t|--tail)
        DOCKER_OPTS+=("-f")
        shift
        ;;
      -n)
        DOCKER_OPTS+=("--tail" "$2")
        shift 2
        ;;
      *)
        DOCKER_OPTS+=("$1")
        shift
        ;;
    esac
  done
  provider_logs "$SERVICE" "${DOCKER_OPTS[@]}"
fi
