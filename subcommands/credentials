#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift

SERVICE="$1"

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:credentials <service>" >&2
  echo "" >&2
  echo "Show credentials for a directory service" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/directory/$SERVICE"

# Check if service exists
if ! directory_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

CONFIG_DIR="$SERVICE_ROOT/config"

# Load provider and get bind credentials (provider-specific format)
load_directory_provider "$SERVICE"

# Capture provider output and also create legacy aliases
PROVIDER_CREDS=$(provider_get_bind_credentials "$SERVICE")
echo "$PROVIDER_CREDS"

# Extract LDAP_BIND_DN from provider output and create BIND_DN alias for backward compatibility
LDAP_BIND_DN=$(echo "$PROVIDER_CREDS" | grep '^LDAP_BIND_DN=' | cut -d= -f2- || true)
if [[ -n "$LDAP_BIND_DN" ]]; then
  echo "BIND_DN=$LDAP_BIND_DN"
fi

# Also output raw admin password and any provider-specific secrets
echo "ADMIN_PASSWORD=$(cat "$CONFIG_DIR/ADMIN_PASSWORD" 2>/dev/null)"
echo "BASE_DN=$(cat "$CONFIG_DIR/BASE_DN" 2>/dev/null)"
if [[ -f "$CONFIG_DIR/JWT_SECRET" ]]; then
  echo "JWT_SECRET=$(cat "$CONFIG_DIR/JWT_SECRET" 2>/dev/null)"
fi
