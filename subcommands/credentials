#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

echo "DEBUG: credentials script starting" >&2
echo "DEBUG: BASH_SOURCE=${BASH_SOURCE[0]}" >&2

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
echo "DEBUG: config sourced, PLUGIN_DATA_ROOT=$PLUGIN_DATA_ROOT" >&2

source "$PLUGIN_BASE_PATH/providers/loader.sh"
echo "DEBUG: loader sourced" >&2

# Strip command prefix if dokku passed it
echo "DEBUG: args before shift: $*" >&2
[[ "${1:-}" == auth:* ]] && shift
echo "DEBUG: args after shift: $*" >&2


SERVICE="$1"
echo "DEBUG: SERVICE=$SERVICE" >&2

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:credentials <service>" >&2
  echo "" >&2
  echo "Show credentials for a directory service" >&2
  exit 1
fi

SERVICE_ROOT="$PLUGIN_DATA_ROOT/directory/$SERVICE"
echo "DEBUG: SERVICE_ROOT=$SERVICE_ROOT" >&2

# Debug: verify paths
if [[ -z "$PLUGIN_DATA_ROOT" ]]; then
  echo "!     PLUGIN_DATA_ROOT is not set" >&2
  exit 1
fi

echo "DEBUG: checking if service exists" >&2
# Check if service exists
if ! directory_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

CONFIG_DIR="$SERVICE_ROOT/config"
echo "DEBUG: CONFIG_DIR=$CONFIG_DIR" >&2

# Load provider and get bind credentials (provider-specific format)
echo "DEBUG: loading provider" >&2
load_directory_provider "$SERVICE"
echo "DEBUG: provider loaded" >&2

# Debug: verify provider function exists
echo "DEBUG: checking provider function" >&2
if ! type provider_get_bind_credentials &>/dev/null; then
  echo "!     Provider function provider_get_bind_credentials not found" >&2
  echo "       Provider file: $PLUGIN_BASE_PATH/providers/directory/$(cat "$SERVICE_ROOT/PROVIDER")/provider.sh" >&2
  exit 1
fi
echo "DEBUG: provider function exists" >&2

# Debug: verify we can read config files
echo "DEBUG: checking config file $CONFIG_DIR/BASE_DN" >&2
if [[ ! -f "$CONFIG_DIR/BASE_DN" ]]; then
  echo "!     Config file not found: $CONFIG_DIR/BASE_DN" >&2
  ls -la "$CONFIG_DIR" >&2 || true
  exit 1
fi
echo "DEBUG: config file exists" >&2

# Capture provider output and also create legacy aliases
echo "DEBUG: calling provider_get_bind_credentials" >&2
PROVIDER_CREDS=$(provider_get_bind_credentials "$SERVICE")
echo "DEBUG: got provider credentials, length=${#PROVIDER_CREDS}" >&2
echo "DEBUG: PROVIDER_CREDS=$PROVIDER_CREDS" >&2
echo "$PROVIDER_CREDS"

# Extract LDAP_BIND_DN from provider output and create BIND_DN alias for backward compatibility
echo "DEBUG: extracting LDAP_BIND_DN" >&2
LDAP_BIND_DN=$(echo "$PROVIDER_CREDS" | grep '^LDAP_BIND_DN=' | cut -d= -f2- || true)
echo "DEBUG: LDAP_BIND_DN=$LDAP_BIND_DN" >&2
[[ -n "$LDAP_BIND_DN" ]] && echo "BIND_DN=$LDAP_BIND_DN"

# Also output raw admin password and any provider-specific secrets
echo "ADMIN_PASSWORD=$(cat "$CONFIG_DIR/ADMIN_PASSWORD" 2>/dev/null)"
echo "BASE_DN=$(cat "$CONFIG_DIR/BASE_DN" 2>/dev/null)"
[[ -f "$CONFIG_DIR/JWT_SECRET" ]] && echo "JWT_SECRET=$(cat "$CONFIG_DIR/JWT_SECRET" 2>/dev/null)"
