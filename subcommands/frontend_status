#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


SERVICE="$1"

if [[ -z "$SERVICE" ]]; then
  echo "Usage: dokku auth:frontend:status <service>" >&2
  exit 1
fi

if ! frontend_service_exists "$SERVICE"; then
  echo "!     Service $SERVICE does not exist" >&2
  exit 1
fi

load_frontend_provider "$SERVICE"

APP_NAME=$(get_frontend_app_name "$SERVICE")

if [[ -n "$APP_NAME" ]]; then
  # Dokku app mode
  if ! "$DOKKU_BIN" apps:exists "$APP_NAME" < /dev/null 2>/dev/null; then
    echo "Service $SERVICE: Dokku app $APP_NAME not found"
    exit 1
  fi
  RUNNING=$("$DOKKU_BIN" ps:report "$APP_NAME" --running < /dev/null 2>/dev/null || echo "false")
  if [[ "$RUNNING" == "true" ]]; then
    echo "Service $SERVICE is running (app: $APP_NAME)"
    exit 0
  else
    echo "Service $SERVICE is stopped (app: $APP_NAME)"
    exit 1
  fi
else
  # Legacy Docker container mode
  CONTAINER_NAME=$(get_frontend_container_name "$SERVICE")
  if docker ps -q -f "name=^${CONTAINER_NAME}$" | grep -q .; then
    echo "Service $SERVICE is running"
    exit 0
  elif docker ps -aq -f "name=^${CONTAINER_NAME}$" | grep -q .; then
    echo "Service $SERVICE is stopped"
    exit 1
  else
    echo "Service $SERVICE container not found"
    exit 1
  fi
fi
