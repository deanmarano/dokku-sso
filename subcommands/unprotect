#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift

APP="$1"

if [[ -z "$APP" ]]; then
  echo "Usage: dokku auth:unprotect <app>" >&2
  echo "" >&2
  echo "Remove SSO protection from an app." >&2
  echo "Auto-detects which frontend service protects this app." >&2
  exit 1
fi

# Find which frontend service protects this app
FRONTEND_DIR="$PLUGIN_DATA_ROOT/frontend"
SERVICE=""

if [[ -d "$FRONTEND_DIR" ]]; then
  for dir in "$FRONTEND_DIR"/*/; do
    [[ -d "$dir" ]] || continue
    svc="$(basename "$dir")"
    if [[ -f "$dir/PROTECTED" ]] && grep -q "^${APP}$" "$dir/PROTECTED"; then
      SERVICE="$svc"
      break
    fi
  done
fi

if [[ -z "$SERVICE" ]]; then
  echo "       App $APP is not protected by any frontend service"
  exit 0
fi

echo "-----> Removing protection from $APP (frontend: $SERVICE)"

load_frontend_provider "$SERVICE"
provider_unprotect_app "$SERVICE" "$APP"

echo "-----> Protection removed from $APP"
