#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/config"
source "$PLUGIN_BASE_PATH/providers/loader.sh"

# Strip command prefix if dokku passed it
[[ "${1:-}" == auth:* ]] && shift


QUIET=""
for arg in "$@"; do
  case "$arg" in
    -q|--quiet)
      QUIET="true"
      ;;
  esac
done

# List directory services
if [[ -z "$QUIET" ]]; then
  echo "=====> Directory services"
fi

if [[ -d "$PLUGIN_DATA_ROOT/directory" ]]; then
  for service_dir in "$PLUGIN_DATA_ROOT/directory"/*/; do
    [[ -d "$service_dir" ]] || continue

    SERVICE=$(basename "$service_dir")
    PROVIDER=$(cat "$service_dir/PROVIDER" 2>/dev/null || echo "unknown")
    if [[ -f "$service_dir/LINKS" ]]; then
      LINK_COUNT=$(wc -l < "$service_dir/LINKS" | tr -d ' ')
    else
      LINK_COUNT=0
    fi

    if [[ -n "$QUIET" ]]; then
      echo "$SERVICE"
    else
      # Check if running (prefer Dokku app, fall back to Docker container)
      APP_NAME=$(cat "$service_dir/APP_NAME" 2>/dev/null || echo "")
      if [[ -n "$APP_NAME" ]]; then
        RUNNING=$("$DOKKU_BIN" ps:report "$APP_NAME" --running < /dev/null 2>/dev/null || echo "false")
        if [[ "$RUNNING" == "true" ]]; then
          STATUS="running"
        else
          STATUS="stopped"
        fi
      else
        CONTAINER_NAME=$(cat "$service_dir/CONTAINER_NAME" 2>/dev/null || get_directory_container_name "$SERVICE")
        if docker ps -q -f "name=^${CONTAINER_NAME}$" | grep -q .; then
          STATUS="running"
        else
          STATUS="stopped"
        fi
      fi

      echo "       $SERVICE ($PROVIDER) - $LINK_COUNT app(s) - $STATUS"
    fi
  done
fi

if [[ -z "$QUIET" ]]; then
  # Check if any services exist
  if [[ ! -d "$PLUGIN_DATA_ROOT/directory" ]] || [[ -z "$(find "$PLUGIN_DATA_ROOT/directory" -mindepth 1 -maxdepth 1 -type d 2>/dev/null)" ]]; then
    echo "       No directory services"
  fi
fi
