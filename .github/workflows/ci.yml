name: CI

on:
  push:
    branches: [main, trunk]
  pull_request:
    branches: [main, trunk]

jobs:
  # Detect which files changed to run only necessary tests
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      # Core plugin code - triggers all tests
      core: ${{ steps.filter.outputs.core }}
      # Shared E2E infrastructure - triggers all E2E tests
      e2e-shared: ${{ steps.filter.outputs.e2e-shared }}
      # Unit/integration test files
      unit-tests: ${{ steps.filter.outputs.unit-tests }}
      integration-tests: ${{ steps.filter.outputs.integration-tests }}
      # Provider-specific changes
      glsso: ${{ steps.filter.outputs.glauth }}
      openldap: ${{ steps.filter.outputs.openldap }}
      authentik: ${{ steps.filter.outputs.authentik }}
      # OIDC subsystem changes
      oidc: ${{ steps.filter.outputs.oidc }}
      # Frontend subsystem changes
      frontend: ${{ steps.filter.outputs.frontend }}
      # Integration-specific changes
      gitea: ${{ steps.filter.outputs.gitea }}
      grafana: ${{ steps.filter.outputs.grafana }}
      gitlab: ${{ steps.filter.outputs.gitlab }}
      nextcloud: ${{ steps.filter.outputs.nextcloud }}
      jellyfin: ${{ steps.filter.outputs.jellyfin }}
      immich: ${{ steps.filter.outputs.immich }}
      radarr: ${{ steps.filter.outputs.radarr }}
      multi-app: ${{ steps.filter.outputs.multi-app }}
      authentik-grafana: ${{ steps.filter.outputs.authentik-grafana }}
      authentik-oauth2-proxy: ${{ steps.filter.outputs.authentik-oauth2-proxy }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            # Core plugin code - any change here triggers all tests
            core:
              - 'commands'
              - 'config'
              - 'install'
              - 'subcommands/**'
              - 'providers/loader.sh'
              - 'providers/directory/lldap/**'
              - 'providers/frontend/authelia/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'

            # Shared E2E test infrastructure
            e2e-shared:
              - 'tests/e2e/helpers.ts'
              - 'tests/e2e/global-setup.ts'
              - 'tests/e2e/global-teardown.ts'
              - 'playwright.config.ts'

            # Unit test files
            unit-tests:
              - 'tests/unit/**'
              - 'vitest.config.ts'

            # Integration test files
            integration-tests:
              - 'tests/integration/**'

            # Alternative directory providers
            glsso:
              - 'providers/directory/glauth/**'
              - 'tests/e2e/glauth.spec.ts'

            openldap:
              - 'providers/directory/openldap/**'
              - 'tests/e2e/openldap.spec.ts'

            # Alternative frontend provider
            authentik:
              - 'providers/frontend/authentik/**'
              - 'tests/e2e/authentik.spec.ts'

            # OIDC subsystem
            oidc:
              - 'subcommands/oidc*'
              - 'tests/e2e/oidc-app.spec.ts'
              - 'tests/e2e/oidc-client.spec.ts'

            # Frontend/protect subsystem
            frontend:
              - 'subcommands/frontend*'
              - 'tests/e2e/protect-unprotect.spec.ts'

            # LDAP core tests
            ldap:
              - 'tests/e2e/ldap-linking.spec.ts'
              - 'tests/e2e/ldap-auth.spec.ts'

            grafana:
              - 'integrations/grafana.sh'
              - 'tests/e2e/grafana-ldap.spec.ts'
              - 'tests/e2e/grafana-oidc.spec.ts'

            gitlab:
              - 'integrations/gitlab.sh'
              - 'tests/e2e/gitlab-ldap.spec.ts'

            nextcloud:
              - 'tests/e2e/nextcloud-ldap.spec.ts'

            jellyfin:
              - 'integrations/jellyfin.sh'
              - 'tests/e2e/jellyfin-ldap.spec.ts'

            immich:
              - 'integrations/immich.sh'
              - 'tests/e2e/immich-oidc.spec.ts'

            radarr:
              - 'integrations/radarr.sh'
              - 'tests/e2e/radarr-forward-auth.spec.ts'

            multi-app:
              - 'tests/e2e/multi-app-integration.spec.ts'

            authentik-grafana:
              - 'tests/e2e/authentik-grafana-ldap.spec.ts'
              - 'tests/e2e/authentik-grafana-oidc.spec.ts'

            authentik-oauth2-proxy:
              - 'tests/e2e/authentik-oauth2-proxy.spec.ts'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.core == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on bash scripts
        run: |
          # Check main scripts
          shellcheck -x commands config install
          # Check subcommands (skip symlinks)
          find subcommands -type f ! -type l -exec shellcheck -x {} +
          # Check provider scripts
          find providers -name "*.sh" -type f -exec shellcheck -x {} +

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.core == 'true' ||
      needs.changes.outputs.unit-tests == 'true' ||
      github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.integration-tests == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          # Allow runner user to run dokku commands
          sudo usermod -aG docker $USER
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
          # Set global domain for app deployments
          sudo dokku domains:set-global test.local

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          # Create plugin data directory
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
          sudo dokku sso:help

      - name: Run integration tests
        run: npm run test:integration
        env:
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Dokku logs ==="
          sudo dokku logs:failed 2>/dev/null || true
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku sso:list 2>/dev/null || true

  # E2E Tests - each job runs only when its specific codepath changes
  # Common condition: push to main/trunk AND (core changed OR e2e-shared changed OR specific files changed)

  e2e-gitea:
    name: E2E - Gitea Integration
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.gitea == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run LDAP linking tests
        run: npx playwright test --project=ldap-linking
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-gitea
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true

  e2e-nextcloud:
    name: E2E - Nextcloud LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.nextcloud == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Install dokku-library plugin
        run: |
          sudo dokku plugin:install https://github.com/deanmarano/dokkufile.git dokkufile || true
          sudo dokku plugin:install https://github.com/deanmarano/dokku-library.git library || true
      - name: Run Nextcloud LDAP tests
        run: npx playwright test --project=nextcloud-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nextcloud
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true

  e2e-multi-app:
    name: E2E - Multi-App Integration
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.multi-app == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run Multi-app integration tests
        run: npx playwright test --project=multi-app-integration
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-multi-app
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true

  e2e-oidc-app:
    name: E2E - OIDC Application
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.oidc == 'true' || needs.changes.outputs.frontend == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 app.test.local" | sudo tee -a /etc/hosts
      - name: Run OIDC application tests
        run: npx playwright test --project=oidc-app
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-oidc-app
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== oauth2-proxy logs ===" && docker logs oauth2-proxy-test 2>&1 || true
          echo "=== Authelia logs ===" && sudo dokku sso:frontend:logs oidc-app-frontend-test -n 100 2>/dev/null || true

  e2e-grafana-ldap:
    name: E2E - Grafana LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.grafana == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Install dokku-library plugin
        run: |
          sudo dokku plugin:install https://github.com/deanmarano/dokkufile.git dokkufile || true
          sudo dokku plugin:install https://github.com/deanmarano/dokku-library.git library || true
      - name: Run Grafana LDAP tests
        run: npx playwright test --project=grafana-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-grafana-ldap
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== Grafana logs ===" && docker logs grafana-ldap-test 2>&1 || true

  e2e-grafana-oidc:
    name: E2E - Grafana OIDC
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.grafana == 'true' || needs.changes.outputs.oidc == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Install dokku-library plugin
        run: |
          sudo dokku plugin:install https://github.com/deanmarano/dokkufile.git dokkufile || true
          sudo dokku plugin:install https://github.com/deanmarano/dokku-library.git library || true
      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 grafana-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grafana-app.test.local" | sudo tee -a /etc/hosts
      - name: Run Grafana OIDC tests
        run: npx playwright test --project=grafana-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-grafana-oidc
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== Grafana logs ===" && docker logs grafana-oidc-test 2>&1 || true
          echo "=== nginx logs ===" && docker logs nginx-grafana-oidc-proxy 2>&1 || true
          echo "=== Authelia logs ===" && sudo dokku sso:frontend:logs grafana-oidc-fe-test -n 100 2>/dev/null || true

  e2e-gitlab-ldap:
    name: E2E - GitLab LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.gitlab == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run GitLab LDAP tests
        run: npx playwright test --project=gitlab-ldap
        timeout-minutes: 20
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-gitlab-ldap
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== GitLab logs ===" && docker logs gitlab-ldap-test 2>&1 | tail -100 || true

  e2e-glsso:
    name: E2E - GLAuth Provider
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.glauth == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run GLAuth tests
        run: npx playwright test --project=glauth
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-glauth
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== GLAuth logs ===" && sudo dokku sso:logs glauth-e2e-test -n 100 2>/dev/null || true

  e2e-openldap:
    name: E2E - OpenLDAP Provider
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.openldap == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run OpenLDAP tests
        run: npx playwright test --project=openldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-openldap
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== OpenLDAP logs ===" && sudo dokku sso:logs openldap-e2e-test -n 100 2>/dev/null || true

  e2e-authentik:
    name: E2E - Authentik Provider
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.authentik == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run Authentik tests
        run: npx playwright test --project=authentik
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          sudo dokku sso:frontend:list 2>/dev/null || true
          echo "=== Authentik server logs ===" && docker logs dokku.sso.frontend.authentik-e2e-test 2>&1 | tail -100 || true
          echo "=== Authentik worker logs ===" && docker logs dokku.sso.frontend.authentik-e2e-test.worker 2>&1 | tail -100 || true

  e2e-authentik-grafana-ldap:
    name: E2E - Authentik + Grafana LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.authentik == 'true' || needs.changes.outputs.grafana == 'true' || needs.changes.outputs.authentik-grafana == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Run Authentik + Grafana LDAP tests
        run: npx playwright test --project=authentik-grafana-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik-grafana-ldap
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          sudo dokku sso:frontend:list 2>/dev/null || true
          echo "=== Authentik logs ===" && docker logs dokku.sso.frontend.ak-graf-ldap-fe 2>&1 | tail -100 || true
          echo "=== Grafana logs ===" && docker logs authentik-grafana-ldap-test 2>&1 | tail -100 || true

  e2e-authentik-grafana-oidc:
    name: E2E - Authentik + Grafana OIDC
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.authentik == 'true' || needs.changes.outputs.grafana == 'true' || needs.changes.outputs.oidc == 'true' || needs.changes.outputs.authentik-grafana == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 authentik-grafana.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grafana-authentik.test.local" | sudo tee -a /etc/hosts
      - name: Run Authentik + Grafana OIDC tests
        run: npx playwright test --project=authentik-grafana-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik-grafana-oidc
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          sudo dokku sso:frontend:list 2>/dev/null || true
          echo "=== Authentik server logs ===" && docker logs dokku.sso.frontend.ak-graf-oidc-fe 2>&1 | tail -100 || true
          echo "=== Grafana logs ===" && docker logs grafana-authentik-oidc-test 2>&1 | tail -100 || true
          echo "=== nginx logs ===" && docker logs nginx-authentik-grafana-proxy 2>&1 | tail -100 || true

  e2e-radarr-forward-sso:
    name: E2E - Radarr Forward Auth
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.radarr == 'true' || needs.changes.outputs.frontend == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Install dokku-library plugin
        run: |
          sudo dokku plugin:install https://github.com/deanmarano/dokkufile.git dokkufile || true
          sudo dokku plugin:install https://github.com/deanmarano/dokku-library.git library || true
      - name: Setup /etc/hosts for forward auth testing
        run: |
          echo "127.0.0.1 radarr-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 radarr-app.test.local" | sudo tee -a /etc/hosts
      - name: Run Radarr Forward Auth tests
        run: npx playwright test --project=radarr-forward-auth
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-radarr-forward-auth
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          sudo dokku sso:frontend:list 2>/dev/null || true
          echo "=== Radarr logs ===" && docker logs radarr-test 2>&1 | tail -100 || true
          echo "=== nginx logs ===" && docker logs nginx-radarr-proxy 2>&1 | tail -100 || true
          echo "=== Authelia logs ===" && sudo dokku sso:frontend:logs radarr-auth-fe -n 100 2>/dev/null || true

  e2e-jellyfin-ldap:
    name: E2E - Jellyfin LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.jellyfin == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Install dokku-library plugin
        run: |
          sudo dokku plugin:install https://github.com/deanmarano/dokkufile.git dokkufile || true
          sudo dokku plugin:install https://github.com/deanmarano/dokku-library.git library || true
      - name: Run Jellyfin LDAP tests
        run: npx playwright test --project=jellyfin-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-jellyfin-ldap
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== Jellyfin logs ===" && docker logs jellyfin-ldap-test 2>&1 | tail -100 || true
          echo "=== LDAP config ===" && cat /tmp/jellyfin-config/plugins/configurations/LDAP-Auth.xml 2>/dev/null || true

  e2e-immich-oidc:
    name: E2E - Immich OIDC
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.immich == 'true' || needs.changes.outputs.oidc == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Install dokku-library plugin
        run: |
          sudo dokku plugin:install https://github.com/deanmarano/dokkufile.git dokkufile || true
          sudo dokku plugin:install https://github.com/deanmarano/dokku-library.git library || true
      - name: Setup /etc/hosts for OIDC test domains
        run: |
          echo "127.0.0.1 immich-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 immich-app.test.local" | sudo tee -a /etc/hosts
      - name: Run Immich OIDC tests
        run: npx playwright test --project=immich-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-immich-oidc
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          echo "=== Immich server logs ===" && docker logs immich-server-test 2>&1 | tail -100 || true
          echo "=== PostgreSQL logs ===" && docker logs immich-postgres-test 2>&1 | tail -50 || true
          echo "=== Redis logs ===" && docker logs immich-redis-test 2>&1 | tail -20 || true
          echo "=== nginx logs ===" && docker logs immich-nginx-tls-proxy 2>&1 | tail -50 || true

  e2e-authentik-oauth2-proxy:
    name: E2E - Authentik + oauth2-proxy
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.e2e-shared == 'true' || needs.changes.outputs.authentik == 'true' || needs.changes.outputs.oidc == 'true' || needs.changes.outputs.authentik-oauth2-proxy == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.37.6/bootstrap.sh
          sudo DOKKU_TAG=v0.37.6 bash bootstrap.sh
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner
      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/sso
          sudo cp -r ./* /var/lib/dokku/plugins/available/sso/
          sudo ln -sf /var/lib/dokku/plugins/available/sso /var/lib/dokku/plugins/enabled/sso
          sudo mkdir -p /var/lib/dokku/services/sso
          sudo chown -R dokku:dokku /var/lib/dokku/services/sso
          sudo dokku plugin:install-dependencies sso || true
      - name: Setup /etc/hosts for OIDC test domains
        run: |
          echo "127.0.0.1 ak-oauth2-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 ak-oauth2-app.test.local" | sudo tee -a /etc/hosts
      - name: Run Authentik + oauth2-proxy tests
        run: npx playwright test --project=authentik-oauth2-proxy
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik-oauth2-proxy
          path: test-results/
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ===" && docker ps -a
          echo "=== Auth services ===" && sudo dokku sso:list 2>/dev/null || true
          sudo dokku sso:frontend:list 2>/dev/null || true
          echo "=== Authentik logs ===" && docker logs dokku.sso.frontend.ak-oauth2-fe 2>&1 | tail -100 || true
          echo "=== oauth2-proxy logs ===" && docker logs authentik-oauth2-proxy-test 2>&1 | tail -100 || true
          echo "=== nginx logs ===" && docker logs nginx-ak-oauth2-proxy 2>&1 | tail -50 || true
