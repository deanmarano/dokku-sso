name: CI

on:
  push:
    branches: [main, trunk]
  pull_request:
    branches: [main, trunk]

jobs:
  # Detect which files changed to skip unnecessary jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      tests: ${{ steps.filter.outputs.tests }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          # Compare against previous commit on push, not merge-base with default branch
          base: ${{ github.event.before }}
          filters: |
            code:
              - 'commands'
              - 'config'
              - 'install'
              - 'subcommands/**'
              - 'providers/**'
              - 'integrations/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
            tests:
              - 'tests/**'
              - 'playwright.config.ts'
              - 'vitest.config.ts'
            e2e:
              - 'tests/e2e/**'
              - 'playwright.config.ts'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on bash scripts
        run: |
          # Check main scripts
          shellcheck -x commands config install
          # Check subcommands (skip symlinks)
          find subcommands -type f ! -type l -exec shellcheck -x {} +
          # Check provider scripts
          find providers -name "*.sh" -type f -exec shellcheck -x {} +

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.tests == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: changes
    # Run on push to main/trunk when code or tests changed
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.tests == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          # Allow runner user to run dokku commands
          sudo usermod -aG docker $USER
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          # Create plugin data directory
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true
          sudo dokku auth:help

      - name: Run integration tests
        run: npm run test:integration
        env:
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Dokku logs ==="
          sudo dokku logs:failed 2>/dev/null || true
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  # E2E tests - only run when code or e2e tests change
  e2e-gitea:
    name: E2E - Gitea Integration
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Gitea integration tests
        run: npx playwright test --project=gitea-integration
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-gitea
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-nextcloud:
    name: E2E - Nextcloud LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Nextcloud LDAP tests
        run: npx playwright test --project=nextcloud-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nextcloud
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-multi-app:
    name: E2E - Multi-App Integration
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Multi-app integration tests
        run: npx playwright test --project=multi-app-integration
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-multi-app
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-oidc-app:
    name: E2E - OIDC Application
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 app.test.local" | sudo tee -a /etc/hosts
          cat /etc/hosts

      - name: Run OIDC application tests
        run: npx playwright test --project=oidc-app
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-oidc-app
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== oauth2-proxy logs ==="
          docker logs oauth2-proxy-test 2>&1 || true
          echo "=== Authelia logs ==="
          sudo dokku auth:frontend:logs oidc-app-frontend-test -n 100 2>/dev/null || true

  e2e-grafana-ldap:
    name: E2E - Grafana LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Grafana LDAP tests
        run: npx playwright test --project=grafana-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-grafana-ldap
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== Grafana logs ==="
          docker logs grafana-ldap-test 2>&1 || true

  e2e-grafana-oidc:
    name: E2E - Grafana OIDC
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 grafana-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grafana-app.test.local" | sudo tee -a /etc/hosts
          cat /etc/hosts

      - name: Run Grafana OIDC tests
        run: npx playwright test --project=grafana-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-grafana-oidc
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== Grafana logs ==="
          docker logs grafana-oidc-test 2>&1 || true
          echo "=== nginx logs ==="
          docker logs nginx-grafana-oidc-proxy 2>&1 || true
          echo "=== Authelia logs ==="
          sudo dokku auth:frontend:logs grafana-oidc-fe-test -n 100 2>/dev/null || true

  e2e-gitlab-ldap:
    name: E2E - GitLab LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run GitLab LDAP tests
        run: npx playwright test --project=gitlab-ldap
        timeout-minutes: 20
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-gitlab-ldap
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== GitLab logs ==="
          docker logs gitlab-ldap-test 2>&1 | tail -100 || true

  e2e-glauth:
    name: E2E - GLAuth Provider
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run GLAuth tests
        run: npx playwright test --project=glauth
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-glauth
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== GLAuth logs ==="
          sudo dokku auth:logs glauth-e2e-test -n 100 2>/dev/null || true

  e2e-openldap:
    name: E2E - OpenLDAP Provider
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run OpenLDAP tests
        run: npx playwright test --project=openldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-openldap
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== OpenLDAP logs ==="
          sudo dokku auth:logs openldap-e2e-test -n 100 2>/dev/null || true

  e2e-authentik:
    name: E2E - Authentik Provider
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Authentik tests
        run: npx playwright test --project=authentik
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          sudo dokku auth:frontend:list 2>/dev/null || true
          echo "=== Authentik server logs ==="
          docker logs dokku.auth.frontend.authentik-e2e-test 2>&1 | tail -100 || true
          echo "=== Authentik worker logs ==="
          docker logs dokku.auth.frontend.authentik-e2e-test.worker 2>&1 | tail -100 || true
          echo "=== PostgreSQL status ==="
          sudo dokku postgres:list 2>/dev/null || true
          echo "=== Redis status ==="
          sudo dokku redis:list 2>/dev/null || true

  e2e-authentik-grafana-ldap:
    name: E2E - Authentik + Grafana LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Authentik + Grafana LDAP tests
        run: npx playwright test --project=authentik-grafana-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik-grafana-ldap
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          sudo dokku auth:frontend:list 2>/dev/null || true
          echo "=== Authentik logs ==="
          docker logs dokku.auth.frontend.ak-graf-ldap-fe 2>&1 | tail -100 || true
          echo "=== Grafana logs ==="
          docker logs authentik-grafana-ldap-test 2>&1 | tail -100 || true

  e2e-authentik-grafana-oidc:
    name: E2E - Authentik + Grafana OIDC
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 authentik-grafana.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grafana-authentik.test.local" | sudo tee -a /etc/hosts
          cat /etc/hosts

      - name: Run Authentik + Grafana OIDC tests
        run: npx playwright test --project=authentik-grafana-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-authentik-grafana-oidc
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          sudo dokku auth:frontend:list 2>/dev/null || true
          echo "=== Authentik server logs ==="
          docker logs dokku.auth.frontend.ak-graf-oidc-fe 2>&1 | tail -100 || true
          echo "=== Authentik worker logs ==="
          docker logs dokku.auth.frontend.ak-graf-oidc-fe.worker 2>&1 | tail -100 || true
          echo "=== Grafana logs ==="
          docker logs grafana-authentik-oidc-test 2>&1 | tail -100 || true
          echo "=== nginx logs ==="
          docker logs nginx-authentik-grafana-proxy 2>&1 | tail -100 || true

  e2e-radarr-forward-auth:
    name: E2E - Radarr Forward Auth
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for forward auth testing
        run: |
          echo "127.0.0.1 radarr-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 radarr-app.test.local" | sudo tee -a /etc/hosts

      - name: Run Radarr Forward Auth tests
        run: npx playwright test --project=radarr-forward-auth
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-radarr-forward-auth
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          sudo dokku auth:frontend:list 2>/dev/null || true
          echo "=== Radarr logs ==="
          docker logs radarr-test 2>&1 | tail -100 || true
          echo "=== nginx logs ==="
          docker logs nginx-radarr-proxy 2>&1 | tail -100 || true
          echo "=== Authelia logs ==="
          sudo dokku auth:frontend:logs radarr-auth-fe -n 100 2>/dev/null || true

  e2e-jellyfin-ldap:
    name: E2E - Jellyfin LDAP
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Jellyfin LDAP tests
        run: npx playwright test --project=jellyfin-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-jellyfin-ldap
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== Jellyfin logs ==="
          docker logs jellyfin-ldap-test 2>&1 | tail -100 || true
          echo "=== LDAP config ==="
          cat /tmp/jellyfin-config/plugins/configurations/LDAP-Auth.xml 2>/dev/null || true

  e2e-immich-oidc:
    name: E2E - Immich OIDC
    runs-on: ubuntu-24.04
    needs: changes
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/trunk') &&
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.e2e == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for OIDC test domains
        run: |
          echo "127.0.0.1 immich-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 immich-app.test.local" | sudo tee -a /etc/hosts

      - name: Run Immich OIDC tests
        run: npx playwright test --project=immich-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-immich-oidc
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== Immich server logs ==="
          docker logs immich-server-test 2>&1 | tail -100 || true
          echo "=== PostgreSQL logs ==="
          docker logs immich-postgres-test 2>&1 | tail -50 || true
          echo "=== Redis logs ==="
          docker logs immich-redis-test 2>&1 | tail -20 || true
          echo "=== nginx logs ==="
          docker logs immich-nginx-tls-proxy 2>&1 | tail -50 || true
