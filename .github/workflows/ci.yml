name: CI

on:
  push:
    branches: [main, trunk]
  pull_request:
    branches: [main, trunk]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on bash scripts
        run: |
          # Check main scripts
          shellcheck -x commands config install
          # Check subcommands (skip symlinks)
          find subcommands -type f ! -type l -exec shellcheck -x {} +
          # Check provider scripts
          find providers -name "*.sh" -type f -exec shellcheck -x {} +

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-24.04
    # Only run on main branch pushes, not PRs (expensive)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          # Allow runner user to run dokku commands
          sudo usermod -aG docker $USER
          echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/dokku" | sudo tee /etc/sudoers.d/dokku-runner

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          # Create plugin data directory
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true
          sudo dokku auth:help

      - name: Run integration tests
        run: npm run test:integration
        env:
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Dokku logs ==="
          sudo dokku logs:failed 2>/dev/null || true
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-gitea:
    name: E2E - Gitea Integration
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Gitea integration tests
        run: npx playwright test --project=gitea-integration
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-gitea
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-nextcloud:
    name: E2E - Nextcloud LDAP
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Nextcloud LDAP tests
        run: npx playwright test --project=nextcloud-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nextcloud
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-multi-app:
    name: E2E - Multi-App Integration
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Multi-app integration tests
        run: npx playwright test --project=multi-app-integration
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-multi-app
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true

  e2e-oidc-app:
    name: E2E - OIDC Application
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 app.test.local" | sudo tee -a /etc/hosts
          cat /etc/hosts

      - name: Run OIDC application tests
        run: npx playwright test --project=oidc-app
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-oidc-app
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== oauth2-proxy logs ==="
          docker logs oauth2-proxy-test 2>&1 || true
          echo "=== Authelia logs ==="
          sudo dokku auth:frontend:logs oidc-app-frontend-test -n 100 2>/dev/null || true

  e2e-grafana-ldap:
    name: E2E - Grafana LDAP
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Run Grafana LDAP tests
        run: npx playwright test --project=grafana-ldap
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-grafana-ldap
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== Grafana logs ==="
          docker logs grafana-ldap-test 2>&1 || true

  e2e-grafana-oidc:
    name: E2E - Grafana OIDC
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Dokku
        run: |
          wget -NP . https://dokku.com/install/v0.35.15/bootstrap.sh
          sudo DOKKU_TAG=v0.35.15 bash bootstrap.sh
          dokku version

      - name: Install plugin
        run: |
          sudo mkdir -p /var/lib/dokku/plugins/available/auth
          sudo cp -r ./* /var/lib/dokku/plugins/available/auth/
          sudo ln -sf /var/lib/dokku/plugins/available/auth /var/lib/dokku/plugins/enabled/auth
          sudo mkdir -p /var/lib/dokku/services/auth
          sudo chown -R dokku:dokku /var/lib/dokku/services/auth
          sudo dokku plugin:install-dependencies auth || true

      - name: Setup /etc/hosts for OIDC testing
        run: |
          echo "127.0.0.1 grafana-auth.test.local" | sudo tee -a /etc/hosts
          echo "127.0.0.1 grafana-app.test.local" | sudo tee -a /etc/hosts
          cat /etc/hosts

      - name: Run Grafana OIDC tests
        run: npx playwright test --project=grafana-oidc
        env:
          CI: true
          DOKKU_HOST: local
          DOKKU_USE_SUDO: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-grafana-oidc
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== Auth services ==="
          sudo dokku auth:list 2>/dev/null || true
          echo "=== Grafana logs ==="
          docker logs grafana-oidc-test 2>&1 || true
          echo "=== nginx logs ==="
          docker logs nginx-grafana-oidc-proxy 2>&1 || true
          echo "=== Authelia logs ==="
          sudo dokku auth:frontend:logs grafana-oidc-fe-test -n 100 2>/dev/null || true
